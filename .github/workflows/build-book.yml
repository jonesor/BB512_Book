name: Build Book

on:
  push:
    branches: ["main", "master"]
  pull_request:
  schedule:
    # Weekly build (Monday 06:00 UTC)
    - cron: "0 6 * * 1"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: "latest"

      - name: Ensure Pandoc On PATH For R
        run: |
          echo "Pandoc path: $(which pandoc)"
          echo "RSTUDIO_PANDOC=$(dirname $(which pandoc))" >> "$GITHUB_ENV"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libxslt1-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libjpeg-dev \
            libtiff5-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libgit2-dev \
            libglpk-dev

      - name: Install R packages
        run: |
          Rscript -e "pkgs <- readLines('packages_used.txt'); pkgs <- unique(c(pkgs, 'bookdown', 'tinytex')); pkgs <- pkgs[nzchar(pkgs)]; install.packages(pkgs, repos='https://cloud.r-project.org', Ncpus=2); missing <- pkgs[!sapply(pkgs, requireNamespace, quietly=TRUE)]; if (length(missing)) { message('Missing packages: ', paste(missing, collapse=', ')); quit(status=1) }"

      - name: Setup TinyTeX
        uses: r-lib/actions/setup-tinytex@v2

      - name: Build book (gitbook)
        run: ./_build.sh

      - name: Build book (pdf)
        run: Rscript -e "bookdown::render_book('index.Rmd', 'bookdown::pdf_book')"
